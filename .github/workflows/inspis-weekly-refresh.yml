name: InspIS Weekly Refresh

on:
  schedule:
    - cron: "45 5 * * 1" # every Monday 05:45 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      pr_url: ${{ steps.create_pr.outputs.pull-request-url }}
      source_url: ${{ steps.resolve.outputs.source_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Resolve current InspIS download URL
        id: resolve
        run: |
          node <<'NODE'
          const https = require('https');
          const fs = require('fs');
          const detailUrl = 'https://opendata.csicr.cz/DataSet/Detail/70';
          const fallback = 'https://opendata.csicr.cz/Transformation/Download/142';
          function get(url){return new Promise((res,rej)=>https.get(url,r=>{let d='';r.on('data',c=>d+=c);r.on('end',()=>res(d));}).on('error',rej));}
          (async()=>{
            let out=fallback;
            try{
              const html = await get(detailUrl);
              const hits = [...html.matchAll(/https:\/\/opendata\.csicr\.cz\/Transformation\/Download\/\d+/g)].map(m=>m[0]);
              if(hits.length>0) out = hits[hits.length-1];
            }catch{}
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `source_url=${out}\n`);
          })().catch((e)=>{console.error(e); process.exit(1);});
          NODE

      - name: Download source CSV/JSON
        run: |
          curl -L --fail "${{ steps.resolve.outputs.source_url }}" -o /tmp/inspis_portal_skoly.csv

      - name: Build InspIS dataset
        run: |
          INSPIS_CSV_PATH=/tmp/inspis_portal_skoly.csv npm run inspis:build-data

      - name: Detect changes
        id: detect
        run: |
          if git diff --quiet -- data/inspis_school_profiles.json data/inspis_coverage_summary.json; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        id: create_pr
        if: steps.detect.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update InspIS dataset from weekly refresh"
          branch: "codex/inspis-weekly-refresh"
          delete-branch: true
          title: "Weekly InspIS refresh: data update detected"
          body: |
            Automated weekly InspIS refresh found data changes.

            Updated:
            - `data/inspis_school_profiles.json`
            - `data/inspis_coverage_summary.json`

            Source URL: `${{ steps.resolve.outputs.source_url }}`

  notify-success:
    runs-on: ubuntu-latest
    needs: refresh
    if: needs.refresh.outputs.changed == 'true'
    steps:
      - name: Send email notification
        if: ${{ secrets.MAIL_USERNAME != '' && secrets.MAIL_PASSWORD != '' && secrets.NOTIFICATION_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[stredniskoly] InspIS data changed and processed"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            InspIS weekly refresh detected data changes and finished successfully.

            PR: ${{ needs.refresh.outputs.pr_url }}
            Source URL: ${{ needs.refresh.outputs.source_url }}
            Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notify-failure:
    runs-on: ubuntu-latest
    needs: refresh
    if: ${{ always() && needs.refresh.result == 'failure' }}
    steps:
      - name: Send failure email
        if: ${{ secrets.MAIL_USERNAME != '' && secrets.MAIL_PASSWORD != '' && secrets.NOTIFICATION_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[stredniskoly] InspIS refresh failed"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            InspIS weekly refresh failed.

            Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Please review logs.
