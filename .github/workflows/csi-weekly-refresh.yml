name: CSI Weekly Refresh

on:
  schedule:
    - cron: "15 5 * * 1" # every Monday 05:15 UTC
  workflow_dispatch:
    inputs:
      force_email:
        description: "Send success email even if no data changes (test mode)"
        type: boolean
        required: false
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.refresh.outputs.changed }}
      pr_url: ${{ steps.create_pr.outputs.pull-request-url }}
      changed_summary: ${{ steps.summary.outputs.changed_summary }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run CSI refresh
        id: refresh
        run: node scripts/process-csi-data.js

      - name: Build changed summary
        id: summary
        run: |
          node <<'NODE'
          const fs=require('fs');
          const d=JSON.parse(fs.readFileSync('data/csi_diff_latest.json','utf8'));
          const s=d.summary||{};
          const out='added:'+(s.schools_added||0)+',removed:'+(s.schools_removed||0)+',changed:'+(s.schools_changed||0);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `changed_summary=${out}\n`);
          NODE

      - name: Create Pull Request
        id: create_pr
        if: steps.refresh.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update CSI data with history and diff snapshot"
          branch: "codex/csi-weekly-refresh"
          delete-branch: true
          title: "Weekly CSI refresh: data update detected"
          body: |
            Automated weekly CSI refresh found data changes.

            Includes:
            - updated `public/csi_inspections.json`
            - updated `data/csi_manifest.json` with valid_from/valid_to versioning
            - updated `data/csi_diff_latest.json`
            - optional new snapshot under `data/csi_snapshots/`

            Diff summary: `${{ steps.summary.outputs.changed_summary }}`

  notify-success:
    runs-on: ubuntu-latest
    needs: refresh
    if: needs.refresh.outputs.changed == 'true' || github.event.inputs.force_email == 'true'
    steps:
      - name: Check mail secrets
        id: mail_check
        env:
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
        run: |
          if [ -n "$MAIL_USERNAME" ] && [ -n "$MAIL_PASSWORD" ] && [ -n "$NOTIFICATION_EMAIL" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Mail secrets are not fully configured; skipping email send."
          fi

      - name: Send email notification
        if: steps.mail_check.outputs.enabled == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[stredniskoly] CSI data changed and processed"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            CSI weekly refresh detected data changes and finished successfully.

            Summary: ${{ needs.refresh.outputs.changed_summary }}
            PR: ${{ needs.refresh.outputs.pr_url }}
            Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notify-failure:
    runs-on: ubuntu-latest
    needs: refresh
    if: ${{ always() && needs.refresh.result == 'failure' }}
    steps:
      - name: Check mail secrets
        id: mail_check
        env:
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
        run: |
          if [ -n "$MAIL_USERNAME" ] && [ -n "$MAIL_PASSWORD" ] && [ -n "$NOTIFICATION_EMAIL" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Mail secrets are not fully configured; skipping email send."
          fi

      - name: Send failure email
        if: steps.mail_check.outputs.enabled == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: false
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "[stredniskoly] CSI refresh failed"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            CSI weekly refresh failed.

            Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Please review logs.
