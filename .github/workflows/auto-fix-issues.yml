name: Auto-Fix Issues

on:
  issues:
    types: [opened, labeled]

jobs:
  validate-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    # Spustit jen pokud má label 'bug-report' nebo 'auto-fix'
    if: |
      contains(github.event.issue.labels.*.name, 'bug-report') ||
      contains(github.event.issue.labels.*.name, 'auto-fix')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Validate issue
        id: validate
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          # Připravit issue data pro validaci (bezpečně escapované)
          jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            --arg url "$ISSUE_URL" \
            '{title: $title, body: $body, url: $url}' > /tmp/issue.json

          # Spustit validaci
          python .github/scripts/validate_issue.py < /tmp/issue.json > /tmp/validation.json

          # Guard: pokud skript nevrátí validní JSON, použít bezpečný fallback
          if ! jq -e '.valid != null and .auto_fix_eligible != null and (.reason | type == "string")' /tmp/validation.json >/dev/null; then
            echo '{"valid": false, "reason": "Validation result is malformed", "auto_fix_eligible": false}' > /tmp/validation.json
          fi

          # Načíst výsledek
          cat /tmp/validation.json

          # Export pro další kroky
          echo "valid=$(jq -r '.valid | tostring' /tmp/validation.json)" >> "$GITHUB_OUTPUT"
          echo "auto_fix=$(jq -r '.auto_fix_eligible | tostring' /tmp/validation.json)" >> "$GITHUB_OUTPUT"
          {
            echo "reason<<EOF"
            jq -r .reason /tmp/validation.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Close invalid issue
        if: steps.validate.outputs.valid == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ github.event.issue.number }} \
            --reason "not planned" \
            --comment "Issue was automatically closed.

          Reason: ${{ steps.validate.outputs.reason }}

          If you think this is a mistake, please contact a maintainer."

      - name: Add auto-fix label
        if: |
          steps.validate.outputs.valid == 'true' &&
          steps.validate.outputs.auto_fix == 'true' &&
          !contains(github.event.issue.labels.*.name, 'auto-fix')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-label "auto-fix"

      - name: Run auto-fix
        if: |
          steps.validate.outputs.valid == 'true' &&
          steps.validate.outputs.auto_fix == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Nastavit git
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@prijimackynaskolu.cz"

          # Spustit auto-fix
          python .github/scripts/auto_fix_issue.py ${{ github.event.issue.number }}

      - name: Notify on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "Automatic fix failed.

          A maintainer will need to apply the fix manually. Thank you for your patience."
